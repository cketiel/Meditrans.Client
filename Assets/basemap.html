<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Trip Route Map</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />

    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }       
    </style>
</head>
<body>

    <input id="autocompleteInput" placeholder="Search address" type="text" class="form-control" />

    <!-- Map container -->
    <div id="map"></div>


    <script>
        let map;
        let marker;

        let autocomplete;
        let input;

        const originLat = parseFloat("{ORIGIN_LAT}");
        const originLng = parseFloat("{ORIGIN_LNG}");


        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 5, // 3
                center: { lat: originLat, lng: originLng },
                mapTypeId: 'roadmap'
            });

            initAutocomplete();
        }

        function setMarkerAt(lat, lng) {
            const position = { lat, lng };

            if (marker) {
                marker.setMap(null);
            }

            marker = new google.maps.Marker({
                draggable: true,
                animation: google.maps.Animation.DROP,
                position,
                map//,
                //icon: 'Assets/icons/pickup.png'
            });

            map.setCenter(position);
            map.setZoom(17);

            google.maps.event.addListener(marker, 'dragend', function () {
                map.setCenter(marker.getPosition());
                geocodePosition(marker.getPosition());
                // marker.getPosition().lat();
                // marker.getPosition().lng();
            });

            marker.addListener("click", toggleBounce);

        }

        function toggleBounce() {
            if (marker.getAnimation() !== null) {
                marker.setAnimation(null);
            } else {
                marker.setAnimation(google.maps.Animation.BOUNCE);
            }
        }

        function setLocation(lat, lng) {
            const pos = { lat, lng };
            map.setCenter(pos);
            marker.setPosition(pos);
        }

        function geocodePosition(pos) {
            geocoder = new google.maps.Geocoder();
            geocoder.geocode({
                latLng: pos
            },
                function (results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        var formattedAddress = results[0].formatted_address;
                        document.getElementById('autocompleteInput').value = formattedAddress;

                        completeAddress(formattedAddress, pos);
                    }
                }
            );
        }

        function initAutocomplete() {
            input = document.getElementById('autocompleteInput');
            autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.addListener('place_changed', () => {
                place_changed();
            });
        }

        function completeAddress(formattedAddress, pos) {
            
            const addressArray = formattedAddress.split(",");
            const result = {
                address: '',
                city: '',
                state: '',
                zip: '',
                lat: pos.lat(),
                lng: pos.lng()
            };
            let stateZip = addressArray[2];
            const stateZipArray = stateZip.split(" ");

            result.address = addressArray[0];
            result.city = addressArray[1];
            result.state = stateZipArray[1];
            result.zip = stateZipArray[2];

            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    type: 'autocomplete',
                    result: result
                });
            }


        }

        function place_changed() {
            const place = autocomplete.getPlace();
            const location = place.geometry?.location;
            if (!location) return;

            const result = {
                address: '',
                city: '',
                state: '',
                zip: '',
                lat: location.lat(),
                lng: location.lng()
            };

            for (const comp of place.address_components) {
                const types = comp.types;
                if (types.includes("street_number")) result.address = comp.long_name + ' ';
                if (types.includes("route")) result.address += comp.long_name;
                if (types.includes("locality")) result.city = comp.long_name;
                if (types.includes("administrative_area_level_1")) result.state = comp.short_name;
                if (types.includes("postal_code")) result.zip = comp.long_name;
            }

            // Enviar a WebView2
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    type: 'autocomplete',
                    result: result
                });
            }

            // Enviar resultado a WPF
            //window.chrome.webview.postMessage(result);
        }

    </script>


    <!--
    <script>
        const originLat = parseFloat("{ORIGIN_LAT}");
        const originLng = parseFloat("{ORIGIN_LNG}");


        function initMap() {
            const map = new google.maps.Map(document.getElementById('map'), {
                zoom: 5,
                center: { lat: originLat, lng: originLng },
                mapTypeId: 'roadmap'
            });
        }
    </script>-->
    <!-- Load Google Maps API and call initMap once it's ready -->
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key={{API_KEY}}&libraries=places&callback=initMap">
    </script>
</body>
</html>
