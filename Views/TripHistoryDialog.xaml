<UserControl x:Class="Meditrans.Client.Views.TripHistoryDialog"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             Width="850" Height="550">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </UserControl.Resources>
    
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <!-- Título -->
            <RowDefinition Height="Auto" />
            <!-- Info del Viaje -->
            <RowDefinition Height="*" />
            <!-- Grid -->
            <RowDefinition Height="Auto" />
            <!-- Botón Cerrar -->
        </Grid.RowDefinitions>

        <!-- 1. Título de la ventana -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
            <materialDesign:PackIcon Kind="History" Width="28" Height="28" Foreground="{DynamicResource PrimaryHueMidBrush}" VerticalAlignment="Center"/>
            <TextBlock Text="Change History" Style="{StaticResource MaterialDesignHeadline5TextBlock}" Margin="10,0,0,0" VerticalAlignment="Center" FontWeight="Bold"/>
            <TextBlock Text="{Binding TripId, StringFormat=' (Trip ID: {0})'}" Style="{StaticResource MaterialDesignHeadline5TextBlock}" VerticalAlignment="Center" Opacity="0.5"/>
        </StackPanel>

        <!-- 2. Información del Viaje (Las 3 líneas requeridas) -->
        <materialDesign:Card Grid.Row="1" Padding="15" Margin="0,0,0,15" Background="{DynamicResource MaterialDesignSelection}" UniformCornerRadius="8">
            <StackPanel>
                <!-- Línea 1: Paciente -->
                <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                    <materialDesign:PackIcon Kind="Account" Width="18" VerticalAlignment="Center" Opacity="0.7"/>
                    <TextBlock Text="{Binding PatientName}" FontWeight="Bold" FontSize="16" Margin="8,0,0,0"/>
                </StackPanel>

                <!-- Línea 2: Pickup Address to -->
                <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                    <materialDesign:PackIcon Kind="MapMarkerOutline" Width="18" VerticalAlignment="Center" Foreground="Green"/>
                    <TextBlock Text="{Binding PickupAddress}" Margin="8,0,5,0" FontSize="13"/>
                    <TextBlock Text="to" FontStyle="Italic" Foreground="{DynamicResource PrimaryHueMidBrush}" FontWeight="Bold"/>
                </StackPanel>

                <!-- Línea 3: Dropoff Address -->
                <StackPanel Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="MapMarkerCheck" Width="18" VerticalAlignment="Center" Foreground="Red"/>
                    <TextBlock Text="{Binding DropoffAddress}" Margin="8,0,0,0" FontSize="13"/>
                </StackPanel>
            </StackPanel>
        </materialDesign:Card>

        <!-- 3. Grid con Scroll Horizontal -->
        <Border Grid.Row="2" BorderThickness="1" BorderBrush="{DynamicResource MaterialDesignDivider}" CornerRadius="4">
            <Grid>
                <DataGrid ItemsSource="{Binding HistoryRecords}" 
                          AutoGenerateColumns="False" 
                          IsReadOnly="True"
                          CanUserAddRows="False"
                          HorizontalScrollBarVisibility="Auto" 
                          VerticalScrollBarVisibility="Auto"
                          Style="{StaticResource MaterialDesignDataGrid}">
                    <DataGrid.Columns>
                        <!-- Fecha y Hora -->
                        <DataGridTextColumn Header="Date Time" 
                                            Binding="{Binding ChangeDate, StringFormat={}{0:MM/dd/yyyy HH:mm:ss}}" 
                                            Width="160"/>

                        <!-- Usuario -->
                        <DataGridTextColumn Header="User" 
                                            Binding="{Binding User}" 
                                            Width="120"/>

                        <!-- Campo modificado -->
                        <DataGridTextColumn Header="Field" 
                                            Binding="{Binding Field}" 
                                            Width="130"
                                            ElementStyle="{StaticResource MaterialDesignDataGridTextColumnStyle}">
                        </DataGridTextColumn>

                        <!-- Valor Anterior (Ancho mínimo para forzar scroll si es largo) -->
                        <DataGridTextColumn Header="Prior Value" 
                                            Binding="{Binding PriorValue}" 
                                            MinWidth="200" Width="Auto"/>

                        <!-- Valor Nuevo (Ancho mínimo para forzar scroll si es largo) -->
                        <DataGridTextColumn Header="New Value" 
                                            Binding="{Binding NewValue}" 
                                            MinWidth="200" Width="Auto"/>
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Loading overlay -->
                <ProgressBar IsIndeterminate="True" 
                             Width="40" Height="40"
                             Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                             Style="{StaticResource MaterialDesignCircularProgressBar}" />
            </Grid>
        </Border>

        <!-- 4. Botón Cerrar -->
        <Button Grid.Row="3" Content="CLOSE" 
                IsCancel="True"
                Style="{StaticResource MaterialDesignFlatButton}"
                HorizontalAlignment="Right" Margin="0,15,0,0"
                Command="{x:Static materialDesign:DialogHost.CloseDialogCommand}" />
    </Grid>
</UserControl>